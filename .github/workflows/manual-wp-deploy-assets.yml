name: 🖼️ Manual Update WordPress.org Assets

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'ASSETS' to confirm update of .wordpress-org assets"
        required: true

permissions:
  contents: read

jobs:
  update-assets:
    name: 🖼️ Update Plugin Assets on WordPress.org
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'ASSETS' }}

    steps:
      # 📦 Checkout only the .wordpress-org directory
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .wordpress-org
          sparse-checkout-cone-mode: false

      # 🪄 Log who triggered the update
      - name: 🪄 Log trigger info
        run: |
          echo "::notice::Triggered by: ${{ github.actor }}"
          echo "::notice::Starting asset update for plugin meteoprog-weather-informers"

     # 🔧 Install SVN
      - name: 🔧 Install Subversion
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y subversion

      # 🔍 Verify .wordpress-org directory exists
      - name: 🔍 Verify assets directory
        run: |
          if [ ! -d ".wordpress-org" ]; then
            echo "::error::.wordpress-org directory not found in repository root."
            exit 1
          fi
          echo "::notice::.wordpress-org directory verified."

      # 🚀 Commit .wordpress-org assets directly to SVN
      - name: 🚀 Upload assets to WordPress.org SVN
        run: |
          set -e
          echo "::notice::Checking out assets SVN directory..."
          svn checkout "https://plugins.svn.wordpress.org/meteoprog-weather-informers/assets" svn-assets --depth immediates --quiet

          echo "::notice::Copying new assets from .wordpress-org/..."
          cp -R .wordpress-org/* svn-assets/

          cd svn-assets
          svn add --force . > /dev/null 2>&1 || true
          svn status

          echo "::notice::Committing changes to WordPress.org..."
          svn commit -m "update plugin assets" \
            --username "${{ secrets.SVN_USERNAME }}" \
            --password "${{ secrets.SVN_PASSWORD }}" \
            --non-interactive --no-auth-cache

      # ✅ Log success result
      - name: ✅ Assets update completed
        if: success()
        run: |
          echo "::notice::✅ Assets updated successfully!"
          echo "::notice::WordPress.org plugin page:"
          echo "::notice::https://wordpress.org/plugins/meteoprog-weather-informers/"
          echo "::notice::SVN assets path:"
          echo "::notice::https://plugins.svn.wordpress.org/meteoprog-weather-informers/assets/"
