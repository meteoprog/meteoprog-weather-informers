name: ğŸ–¼ï¸ Manual Update WordPress.org Assets

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'ASSETS' to confirm update of .wordpress-org assets"
        required: true

permissions:
  contents: read

jobs:
  update-assets:
    name: ğŸ–¼ï¸ Update Plugin Assets on WordPress.org
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'ASSETS' }}

    steps:
      # ğŸ“¦ Checkout only the .wordpress-org directory
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .wordpress-org
          sparse-checkout-cone-mode: false

      # ğŸª„ Log who triggered the update
      - name: ğŸª„ Log trigger info
        run: |
          echo "::notice::Triggered by: ${{ github.actor }}"
          echo "::notice::Starting asset update for plugin meteoprog-weather-informers"

      # ğŸ”§ Install SVN
      - name: ğŸ”§ Install Subversion
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y subversion

      # ğŸ” Verify .wordpress-org directory exists
      - name: ğŸ” Verify assets directory
        run: |
          if [ ! -d ".wordpress-org" ]; then
            echo "::error::.wordpress-org directory not found in repository root."
            exit 1
          fi
          echo "::notice::.wordpress-org directory verified."

      # ğŸš€ Commit .wordpress-org assets directly to SVN (always up-to-date)
      - name: ğŸš€ Upload assets to WordPress.org SVN
        run: |
          set -e

          echo "::notice::Checking out assets SVN directory..."
          rm -rf svn-assets
          svn checkout "https://plugins.svn.wordpress.org/meteoprog-weather-informers/assets" svn-assets \
            --depth infinity --quiet --non-interactive --trust-server-cert

          echo "::notice::Copying new assets from .wordpress-org/..."
          if [ -z "$(ls -A .wordpress-org)" ]; then
            echo "::error::.wordpress-org directory is empty â€” nothing to sync."
            exit 1
          fi

          rsync -a --delete --quiet --exclude=".svn" .wordpress-org/ svn-assets/

          cd svn-assets

          # ğŸ§¹ Remove obsolete files that are not present in .wordpress-org
          echo "::notice::Removing obsolete files..."
          find . -type f ! -path "./.svn/*" | while read -r file; do
            rel="${file#./}"
            if [ ! -f "../.wordpress-org/$rel" ]; then
              echo "::notice::Removing $rel"
              svn rm --force "$rel" > /dev/null 2>&1 || true
            fi
          done

          # â• Add new and modified files
          svn add --force --quiet . > /dev/null 2>&1 || true

          echo "::group::ğŸ” SVN status (before commit)"
          svn status
          echo "::endgroup::"

          # ğŸ’¾ Commit if there are any changes
          if svn status | grep -q "^[AMR]"; then
            echo "::notice::Detected changes, committing to WordPress.org assets directory..."
            svn commit -m "update plugin assets" \
              --username "${{ secrets.SVN_USERNAME }}" \
              --password "${{ secrets.SVN_PASSWORD }}" \
              --non-interactive --no-auth-cache --trust-server-cert

            echo "::notice::âœ… Assets successfully updated at https://plugins.svn.wordpress.org/meteoprog-weather-informers/assets/"
          else
            echo "::notice::No changes detected â€” skipping commit."
          fi

      # âœ… Log success result
      - name: âœ… Assets update completed
        if: success()
        run: |
          echo "::notice::âœ… Assets updated on WordPress.org (meteoprog-weather-informers)"